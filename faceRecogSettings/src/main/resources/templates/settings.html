<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
  th:include="fragments/layout :: page" lang="en" dir="ltr">
<head>
<title>Settings</title>
</head>
<body>
  <div th:fragment="content">
    <!--  -->

    <h1>Settings</h1>

    <div class="grid-x grid-padding-x">
      <div class="large-4 cell"></div>
      <div class="large-4 cell">

        <p class="lead error text-center error-message" id="get-error"></p>

        <label for="api-key">Api key: <input type="text" name="api-key" id="api-key" th:value="${settings.apiKey}" readonly></label>

        <fieldset class="form-border">
          <legend>Manage Faces</legend>
          <form id="face-form">
            <label>Faces: <select id="faces" th:disabled="${#lists.isEmpty(settings.faces)}">
                <option th:each="face:${settings.faces}" th:text="${face.name}" th:id="${face.id}" th:value="${face.id}"></option>
                <option th:if="${#lists.isEmpty(settings.faces)}">None</option>
            </select>
            </label>
            <p>
              Status: <span id="learn-face-status" th:data-learn-id="${settings.recognitionId}"
                th:data-learning="${settings.recognitionId} > 0 ? enabled: disabled"
                th:text="${settings.recognitionId} > 0 ? 'Learning face ' + ${settings.faces.?[id == settings.recognitionId][0].name}: 'Detecting'"></span>
            </p>
            <div class="button-group">
              <a class="button" id="open-face-modal" data-open="add-face-modal">Create</a> <a id="remove-face" class="button error"
                th:classappend="${#lists.isEmpty(settings.faces)} ? disabled">Remove</a> <a id="learn-face" class="button success"
                th:classappend="${#lists.isEmpty(settings.faces)} ? disabled" th:text="${settings.recognitionId} > 0 ? 'Stop Learn': 'Learn'">Learn</a>
            </div>
            <p class="error error-message" id="face-error"></p>

            <div class="reveal" id="add-face-modal" data-reveal>
              <h1>Create Face</h1>
              <label for="face-name">Name:<input type="text" name="face-name" id="face-name"></label> <a href="javascript:void(0)"
                class="button success float-right" id="add-face">Add</a>
              <p class="modal-error error error-message"></p>
              <button class="close-button" data-close aria-label="Close modal" type="button">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </form>
        </fieldset>

        <fieldset class="large-5 cell form-border">
          <legend>Notify if face is</legend>
          <input type="radio" name="notify-if" value="true" th:checked="${settings.notifyIfDetected == true}? true : false" id="notify-if-true"
            required> <label for="notify-if-true">detected</label> <input type="radio" name="notify-if" value="false"
            th:checked="${settings.notifyIfDetected == true}? false : true" id="notify-if-false"> <label for="notify-if-false">not
            detected</label> <label id="notifyIfStatus" class=""></label>
        </fieldset>

        <fieldset class="form-border">
          <legend>Manage Notifications</legend>
          <form id="notification-form">

            <div th:each="name : ${T(se.anderssonbilly.faceRecogSettings.dao.NotificationTypeEnum).values()}"
              th:id="'notification-method-' + ${name} + 'container'">
              <label><span th:text="${name}"></span> <select th:id="'notification-method-' + ${name}">
              </select> </label>
              <div class="button-group">
                <a class="button open-notification-modal" th:data-notification-type="${name}" data-open="add-notification-modal">Create</a> <a
                  class="remove-notification button error" th:data-notification-type="${name}"
                  th:classappend="${#lists.isEmpty(settings.notifications)} ? disabled">Remove</a>

              </div>
              <p class="error error-message" th:id="${name} + '-error'"></p>
              <hr>
            </div>

            <div class="reveal" id="add-notification-modal" data-reveal>
              <h1>Create Notification</h1>
              <label for="notification-name"><span id="notification-text">Send to:</span><input type="text" name="notification-name"
                id="notification-name"></label> <a href="javascript:void(0)" class="button success float-right" id="add-notification">Add</a>
              <p class="modal-error error error-message"></p>
              <button class="close-button" data-close aria-label="Close modal" type="button">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </form>
        </fieldset>

        <fieldset class="form-border">
          <legend>Change Password</legend>
          <form id="change-password-form">
            <label>Password <input id="password" type="password" placeholder="Password">
            </label> <label>Confirm password <input id="matching-password" type="password" placeholder="Password">
            </label> <a id="change-password" class="button">Create</a>
            <ul id="password-error" class="error"></ul>
          </form>
        </fieldset>

      </div>
      <div class="large-4 cell"></div>
    </div>



    <script th:inline="javascript" type="text/javascript">
          function r(f) {
            /in/.test(document.readyState) ? setTimeout('r(' + f + ')', 9) : f()
          }

          r(function() {

            ///////////////
            // Variables //
            ///////////////
            //

            var addFaceUrl = "/addFace";
            var removeFaceUrl = "/removeFace";
            var getFacesUrl = "/getFaces";
            var updateNotifyIfUrl = "/updateNotifyIf";
            var addNotificationUrl = "/addNotification";
            var removeNotificationUrl = "/removeNotification";
            var getNotificationsUrl = "/getNotifications";
			var learnFaceUrl = "/learnFace";
            var changePasswordUrl = "/changePassword";
			
            /*<![CDATA[*/
            var notificationTypes = /*[[${T(se.anderssonbilly.faceRecogSettings.dao.NotificationTypeEnum).values()}]]*/;
            var notifications = /*[[${settings.notifications}]]*/;
            /*]]>*/
            
            //
            ///////////////
            
            //////////
            // Init //
            //////////
            //
            
            displayNotifications();
            
            //
            //////////
            
            ///////////////////////////////
            // Adding and removing faces //
            ///////////////////////////////
            //
            // Clear name text input when opening modal
            $("#open-face-modal").on("click", function() {
              $("#face-name").val("");
              $(".error-message").text("");
            });

            // Call ajax POST to add face to db
            $("#add-face").on("click", function() {
              if (!$(this).hasClass("disabled")) {
                $(this).addClass("disabled");
                ajaxPost(addFaceUrl, {"name":$("#face-name").val()}, function(data) {
                  $(".close-button").click();
                  $("#face-name").val("");
                  $("#add-face").removeClass("disabled");
                  getFaces();
                }, function(data) {
                  $("#add-face").removeClass("disabled");
                  $(".modal-error").text(data.responseText);
                });
              }
            });

            // Call ajax POST to remove face from db
            $("#remove-face").on("click", function(data) {
              if (!$(this).hasClass("disabled")) {
                
                confirm("Delete face?",$("#faces option:selected").text(), function() {
                  $(this).addClass("disabled");
                  var removeId = $("#faces").val();
                  ajaxPost(removeFaceUrl, removeId, function() {
                    if(removeId == $("#learn-face-status").attr("data-learn-id"))
                      setLearnFaceText(false);
                    getFaces();
                  }, function(data) {
                    $("#remove-face").removeClass("disabled");
                    $("#face-error").text(data.responseText);
                  });
                });
                
              }
            });
            
            // When clicking learn toggle recognitionId in database
            $("#learn-face").on("click",function(){
              if (!$(this).hasClass("disabled")) {
                toggleLearnFace($("#faces").val());
              }
            });
            
            // Function to toggle recognitionId
            function toggleLearnFace(id){
              ajaxPost(learnFaceUrl, id, function() {
                $("#learn-face-status").attr("data-learn-id", id);
                $("#learn-face-status").attr("data-learning", 
                    $("#learn-face-status").attr("data-learning") == "enabled" ? "disabled" : "enabled");
                if($("#learn-face-status").attr("data-learning") == "enabled")
                  setLearnFaceText(true, $("#faces option:selected").text());
                else
                  setLearnFaceText(false);
              }, function(data) {
                $("#learn-face-status").text(data.responseText);
              });
            }
            
            //Function to set text of learn status and button
			function setLearnFaceText(enabled, face){
			  if(enabled){
                $("#learn-face-status").text("Learning face " + face);
              	$("#learn-face").text("Stop Learn");
			  }else{
                $("#learn-face-status").text("Detecting");
                $("#learn-face").text("Learn");
			  }
			}
            
            // Method to GET faces from db
            var getFaces = function() {
              ajaxGet(getFacesUrl, function(data) {
                $("#faces").html("");
                if (data.length > 0) {
                  $("#faces").prop("disabled", false);
                  $("#learn-face").removeClass("disabled");
                  $("#remove-face").removeClass("disabled");
                  $.each(data, function(i, val) {
                    $("#faces").append("<option id='" + val.id + "' value='" + val.id + "'>" + val.name + "</option>");
                  });
                } else {
                  $("#faces").prop("disabled", true);
                  $("#remove-face").addClass("disabled");
                  $("#learn-face").addClass("disabled");
				  setLearnFaceText(false);
                  $("#faces").append("<option>None</option>");
                }
              }, function(data) {
                $("#get-error").append("\nCould not get Faces.");
              });
            }
            
            //
            ///////////////////////////////

            ///////////////////
            // Notifications //
            ///////////////////
            //
            
            // Make Ajax POST when changing notify if
            $("input[type=radio][name=notify-if]").on("change", function() {
              ajaxPost(updateNotifyIfUrl, $(this).val(), function(data) {
                $("#notifyIfStatus").removeClass("error").addClass("success").text("Change applied successfully");
              }, function(data) {
                $("#notifyIfStatus").removeClass("success").addClass("error").text("Error: " + data);
              });
            });

            // Clear text input when opening modal and set input to correct type
            $(".open-notification-modal").on("click", function() {
              var type = $(this).data("notification-type");
              $("#notification-name").val("").attr("data-notification-type",$(this).data("notification-type"));
              $(".error-message").text("");
              
              switch(type){
              case "email":
                $("#notification-text").html("Email to recieve notifications:");  
                $("#notification-name").unbind("input keydown keyup mousedown mouseup select contextmenu drop");
                $("#notification-name").inputFilter(function(value) {
                  return /^[^ ]*$/i.test(value)
                });
                break;
              case "sms":
                $("#notification-text").html("Phone number to recieve notification:");
                $("#notification-name").unbind("input keydown keyup mousedown mouseup select contextmenu drop");
                $("#notification-name").inputFilter(function(value) {
                  return /^\d*$/.test(value);
                });
                break;
                default:
                  $("#notification-text").html("Unknown input.");
                  break;
              }
            });

            // Call ajax POST to add notification to db
            $("#add-notification").on("click", function() {
              if (!$(this).hasClass("disabled")) {
                $(this).addClass("disabled");
                var payload = {
                  "type" : $("#notification-name").attr("data-notification-type"),
                  "name" : $("#notification-name").val()
                }
                ajaxPost(addNotificationUrl, payload, function(data) {
                  $(".close-button").click();
                  $("#notification-name").val("");
                  $("#add-notification").removeClass("disabled");
                  getNotifications();
                }, function(data) {
                  $("#add-notification").removeClass("disabled");
                  $(".modal-error").text(data.responseText);
                });
              }
            });

            // Call ajax POST to remove notification from db
            $(".remove-notification").on("click", function(data) {
              var removeButton = $(this);
              
              if (!removeButton.hasClass("disabled")) {  
                var element = "#notification-method-" + removeButton.data("notification-type");
                confirm("Delete " + removeButton.data("notification-type") + " notification?",$(element + " option:selected").text(), function() {
                  removeButton.addClass("disabled");
                  ajaxPost(removeNotificationUrl, $(element).val(), function() {
                    getNotifications();
                  }, function(data) {
                    removeButton.removeClass("disabled");
                    $("#" + removeButton.data("notification-type") + "-error").text(data.responseText);
                  });
                
                });
                
              }
            });

            // Method to GET notifications from db
            var getNotifications = function() {
              ajaxGet(getNotificationsUrl, function(data) {
                notifications = data;
                displayNotifications();
              }, function(data) {
                $("#get-error").append("\nCould not get notifications.");
              });
            }
            
            function displayNotifications(){
              $("[id^=notification-method] select").html("");
              
              $.each(notifications, function(i,val){
                $("#notification-method-" + val.type).append("<option id='" + val.id + "' value='" + val.id + "'>" + val.name + "</option>");
              });
              $("[id^=notification-method] select").attr("disabled",false).parent().parent().find(".remove-notification").removeClass("disabled");
              $("[id^=notification-method] select:not(:has(option))").attr("disabled",true).append("<option>None</option>").parent().parent().find(".remove-notification").addClass("disabled");
            }
            
            //
            ///////////////////

            /////////////////////
            // Change Password //
            /////////////////////
            //
            
            $("#change-password").on("click",function(){
              $("#password-error").text("");
              $("#password").removeClass("inputError");
              $("#matching-password").removeClass("inputError");
              
              ajaxPost(changePasswordUrl,
                  {
                	"password": $("#password").val(),
                	"matchingPassword": $("#matching-password").val()
                  },
                  function(){
                    $("#password").val("");
                    $("#matching-password").val("");
                  },
                  function(data){
                    $("#matching-password").val("");
                    
                    $("#password").addClass("inputError");
                    $("#matching-password").addClass("inputError");
                    
                    //$("#password-error").text(data.responseText);
                    var errors = data.responseText.split(",");
                    $.each(errors, function(i,val){
                      $("#password-error").append($("<li>").html(val));
                      //if(i < errors.length -1)
                        //$("#password-error").append("<br>");
                    });
                    
                  });
            });
            
            //
            /////////////////////
            
            /////////////
            // Methods //
            /////////////
            //

            // ajaxPOST method
            var ajaxPost = function(url, data, success, error) {
              $(".error-message").text("");
              $("#notifyIfStatus").text("");
              $.ajax({
                type : "POST",
                contentType : "application/json",
                url : url,
                data : JSON.stringify(data),
                timeout : 500000,
                success : function(data) {
                  success(data);
                },
                error : function(e) {
                  error(e);
                }
              })
            }

            // ajaxGET method
            var ajaxGet = function(url, success, error) {
              $(".error-message").text("");
              $("#notifyIfStatus").text("");
              $("#password-error").text("");
              $("#password").removeClass("inputError");
              $("#matching-password").removeClass("inputError");
              $.ajax({
                type : "GET",
                contentType : "application/json",
                url : url,
                dataType : 'json',
                timeout : 500000,
                success : function(data) {
                  success(data);
                },
                error : function(e) {
                  error(e);
                }
              })
            }
            
           // Restricts input for each element in the set of matched elements to the given inputFilter.
            $.fn.inputFilter = function(inputFilter) {
              return this.on("input keydown keyup mousedown mouseup select contextmenu drop", function() {
                if (inputFilter(this.value)) {
                  this.oldValue = this.value;
                  this.oldSelectionStart = this.selectionStart;
                  this.oldSelectionEnd = this.selectionEnd;
                } else if (this.hasOwnProperty("oldValue")) {
                  this.value = this.oldValue;
                  this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
                }
              });
            };
             
          	// Create confirmation modal
        	function confirm(title, message, callback) {
          		var modal = '<div class="reveal small" id="confirmation">'+
          			     		'<h2>'+title+'</h2>'+
          			   		'<p class="lead">'+message+'</p>'+
                   			'<button class="button success yes">Yes</button>'+
          			    		'<button class="button alert float-right" data-close>No</button>'+
          		       		'</div>';
          		$('body').append(modal);
          		var confirmation = new Foundation.Reveal($('#confirmation'));
          		confirmation.open();
              
          		$('#confirmation').children('.yes').on('click', function() {
          			confirmation.close();
          			$('#confirmation').remove();
                	callback.call();
              	});
          		$(document).on('closed.zf.reveal', '#confirmation', function() {
          			$('#confirmation').remove();
          		});
  
   	 		}
          
            //
            /////////////
          });
        </script>

    <!--  -->
  </div>
</body>
</html>